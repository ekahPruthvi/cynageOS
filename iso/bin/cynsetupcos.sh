#!/bin/bash
# setup files for cynageOS 
# ekahPruthvi <https://github.com/ekahPruthvi>

set -e

USERR="$(cat bob.txt)"

cat <<EOT > /mnt/root/cyn.sh
# @@@@@%%%%%%%%%####********+++++++++++++++++++******########%%%%%%%%%%%%%%%%%%%%%%%%%##%######
# @@@@@@@%%%####************++++++++++++++++++++++******########%%%%%%%%%%%%%%%%%%%%%%%#%######
# @@@@%%%%%%%%####*********++++++++++++++++++++++++*******########%%%#%%%%%%%%%%%%%%%%%%#######
# @@@@%%%%%%#####***********+*+++++++++++++++++++++*++******#*########%%%%%%%%%%%%%%%%%%#######
# @@@@%%%%%%######************+**+**++++++++++*+**++++++*****############%%%%%%%%%%%%%%########
# @@%%%%######******************+++++++++++++++++++++++++++******#########%%#%%%%%##%%%########
# @@%%%########*******************++++++++++++++++++++++++++++++*+****########%%%%%##%%########
# @%%%%%####*************************++++++++++++++++=++++++++++++++**#*########%%%%%#%%%#%%%%%
# %%%%%######***************************+++++++++++++==+++++++=++==+=+++**########%%%%%%%%%%%%%
# %%%%%#######**#**#********************+++++++++++++++++=++===+==+++=+++****#######%%%%%%%%%%%
# %%%%#########*##########*******************************+++++++===-=+++=++****#######%%%%%%%%%
# %%%%#############################****************+*++*******+=-=========+++****#######%%%%%%%
# %%%%##########################*****************+++*++++*+++++*#*=:-=--===++++*****#####%%%%%%
# %%%%##################%%########*****************+***++++++*+******=--======++*****######%%%%
# %%%%#############%%%%%#########*****************++++++=+++++++++++**#+=-=====++*******####%%%
# %%%%########%%%%%%%%%%%%%%########*****************+++++++====+++++++***+-==++++*******###%%%
# %%%%%%%%%%%%%%%%%%%%%%%%###########************+++++=++=+===+++==++++++***+==+++*******###%%%
# %%%%%%%%%%%%%%%%%%%%%%%###############**********+++====++++======+==+++++***++++********##%%%
# %%%%%%%%%%%%%%%%%%%%%%%#######################**+*+++==+==++++++====+++++++***+++********##%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%#%%%%%%%%%%%%%%%%%%#####****++++++++++++***+++******###%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%@@@@@@@@@@@@@@@@@@@@@%%%%%#######**++++*++++**++**######%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@%%@@%%%%%%%%%%%%%%##**++++++*****#####%%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@#*%==%%%%####%%%%%%%%%%%##*++++++***#####%%%
# %%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@%%#%%%=+%%%%*==++*##%%%%%%%%%%%#*++++***###%%%%
# %%%%%%%%%%%%%%%%%%%%%@@@@@@@@%%%@@@@@@@@@@@@@@@%%%%%=*%%%%#+---==+*#%%%%%%%%%%%%#*++**###%%%%
# %%%%%%%%%%%%%%%%%@@@@@@@@@%%%%%%@@@@@@@@@@%@@@@@@@%%%%%%%%%*=-----=+**##%%%%@@%%%%######%%%%%
# %%%%%%%%%%%%%%%%%@@@@@@@@%%%#%%%@@@@@@@@%%@@@@@%%%%#%@@%%%%*=--::--==++*#%%%%%%@@@%%%%#%%%%%%
# %%%%%%%%%%%%%@@@@@@@@@@@@%%%###%%@@@@@@@@@@@@@%@@@@@@@%%%%%*=-::::---==+*##%%%%%@%%%%%%%%%%%%
# %%%%%%%%@@@@@@@@@@@@@@@%%%%#####%%@@@@@@@@@@%@@@@@@@@%%%%%#+=-::::---==+**##%%%%%%##%%%%%%%%%
# %%%%%%%%%%%@@@@@@@@@@@@@%%%%%%##%%@@@@@@@@@@@@@@@@%%%%%%%%*=--:::----==++*##%#######%%%%%#%%%
# %%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%%%@@@@@@%%%%%@@%%%%%%%%#+=-:::-=++*****+**#***#####%%%%####%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@%%%%%%%%%%#+=-+++*******+++**#***##**##%%########
# #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%################******+*++***+++++*###*******##############
# ###%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%########*#**#*************###**********###############
# #######%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%####%###########*##**########***********###############%
# #######################%%%%%%%%%%%%%%%%%%%##%%%%%###########****************##*******########
# ##############*#************###############%%%######**********************************######%
# #***************************************************++++*+++++++**+*+*****************######%
# ***************+*+++++++++++++++++++++++++++++++++++++++++++++++++******++***********#######%
# ***********+++*+++++++++++++++++++++++++++++++++++++++++++++********++++++++********#######%%
# ******++++++++++++++++++++++++++++++++++++++++++++++**+*********+++++++++++++******######%%%%
# *****+++++++++++++++++++++++++++++++++++++++**++*+******++++++++++++++++++++++****######%%%%%
# ***+++++++++++++=+++++===+++++++++++++++++++++++++++++++++++++++++++++++++++++****######%%%%%
# ****++++++++++++++++++==+++++++=++=+++++++++++++++++++=+++++++++++++++++++++++***######%%%%%%
# *++++++++++++++++++=+==++=========++++==+=++++++++======++=+++===++++++++++++****#####%%%%%%%
# ***++++++++++++++++++==+=====================+================+========+=+++*****#####%%%%%%#
# *****++++++++++++++=++=======================================+========++++++*****####%%%%%###
# ******++++++++++++++=================================================+===++++***####%%%%####*
# ******+++++++++++++++===============================================+==+++++****###%%%#####**
# ******++++++++++++++=================================================+=+++++***###%%%########
# *****+++++++++++++======+==============================-===============+++++**###%%%#########
# ***+*+++++++++++++==+===================================-========-=====+++++**##%%%##########
# ***+++++++++++++++===================================-=-=-===----=====+=+++**##%%%###########
# ****++++++++++++++=====+===========================-=-=-==---==--===++++=+**##%%%%###########
# **++++++++*+++======+=++===============================----=-=--=====++++**##%%%%############

cat << EOF

░▀█▀░█▀▀▄░█▀▀░▀█▀░█▀▀▄░█░░█░░░▀░░█▀▀▄░█▀▀▀
░▒█░░█░▒█░▀▀▄░░█░░█▄▄█░█░░█░░░█▀░█░▒█░█░▀▄
░▄█▄░▀░░▀░▀▀▀░░▀░░▀░░▀░▀▀░▀▀░▀▀▀░▀░░▀░▀▀▀▀

░█▀▀▄░█▀▀░█▀▀█░█░▒█░░▀░░█▀▀▄░█▀▀░█▀▄
░█▄▄▀░█▀▀░█▄▄█░█░▒█░░█▀░█▄▄▀░█▀▀░█░█
░▀░▀▀░▀▀▀░░░░█░░▀▀▀░▀▀▀░▀░▀▀░▀▀▀░▀▀░

░▄▀▀▄░█▀▀▄░▄▀▀▄░█▀▀▀░█▀▀▄░█▀▀▄░█▀▄▀█░█▀▀░░░░░
░█▄▄█░█▄▄▀░█░░█░█░▀▄░█▄▄▀░█▄▄█░█░▀░█░▀▀▄░░░▄▄
░█░░░░▀░▀▀░░▀▀░░▀▀▀▀░▀░▀▀░▀░░▀░▀░░▒▀░▀▀▀░░░▀▀

EOF

sleep 2s

cp /etc/sudoers /etc/sudo.bak
echo "%wheel ALL=(ALL) NOPASSWD: /usr/bin/pacman" >> /etc/sudoers

if lspci | grep -E -i 'nvidia|geforce'; then
  pacman -Sy --needed --noconfirm nvidia-open nvidia-utils lib32-nvidia-utils
elif lspci | grep -E -i 'amd|ati|radeon'; then
  pacman -Sy --needed --noconfirm xf86-video-amdgpu linux-firmware-amdgpu linux-firmware-radeon vulkan-radeon
fi 

shopt -s nullglob
pkgs=(/root/req_pkgs/*)

if [ ${#pkgs[@]} -gt 0 ]; then
  pacman -U --noconfirm "${pkgs[@]}"
else
  echo "No .pkg.tar.zst files found in /root/req_pkgs/"
fi
shopt -u nullglob

sudo -u "$USER" yay -U --noconfirm "$pkg"

mv /etc/sudo.bak /etc/sudoers

cat << EOF

░▒█▀▀█░█▀▀░▀█▀░▀█▀░░▀░░█▀▀▄░█▀▀▀
░▒█░▄▄░█▀▀░░█░░░█░░░█▀░█░▒█░█░▀▄
░▒█▄▄▀░▀▀▀░░▀░░░▀░░▀▀▀░▀░░▀░▀▀▀▀

░█▀▄░█░░█░█▀▀▄░█▀▀▄░█▀▀▀░█▀▀░▒█▀▀▀█░▒█▀▀▀█
░█░░░█▄▄█░█░▒█░█▄▄█░█░▀▄░█▀▀░▒█░░▒█░░▀▀▀▄▄
░▀▀▀░▄▄▄▀░▀░░▀░▀░░▀░▀▀▀▀░▀▀▀░▒█▄▄▄█░▒█▄▄▄█

░█▀▀░█▀▄░▄▀▀▄░█▀▀░█░░█░█▀▀░▀█▀░█▀▀░█▀▄▀█
░█▀▀░█░░░█░░█░▀▀▄░█▄▄█░▀▀▄░░█░░█▀▀░█░▀░█
░▀▀▀░▀▀▀░░▀▀░░▀▀▀░▄▄▄▀░▀▀▀░░▀░░▀▀▀░▀░░▒▀

░▒█▀▀▄░█▀▀░█▀▀▄░█▀▄░█░░█░░░░░
░▒█▄▄▀░█▀▀░█▄▄█░█░█░█▄▄█░▄▄░░
░▒█░▒█░▀▀▀░▀░░▀░▀▀░░▄▄▄▀░▀▀░░

EOF

sed -i -E -e "s|^command = .*|command = \"cage -m last -s /usr/bin/octobacillus\"|" "/etc/greetd/config.toml"
systemctl enable greetd.service

cat << EOF

░▒█▀▀▀░░▀░░█▀▀▄░░▀░░█▀▀░█░░░░░▀░░█▀▀▄░█▀▀▀
░▒█▀▀░░░█▀░█░▒█░░█▀░▀▀▄░█▀▀█░░█▀░█░▒█░█░▀▄
░▒█░░░░▀▀▀░▀░░▀░▀▀▀░▀▀▀░▀░░▀░▀▀▀░▀░░▀░▀▀▀▀

░░░▀▀█▀▀░█░░░░█▀▀░█▀▄▀█░░▀░░█▀▀▄░█▀▀▀░░░░░░░
░░░░▒█░░░█▀▀█░█▀▀░█░▀░█░░█▀░█░▒█░█░▀▄░░░▄▄░░
░░░░▒█░░░▀░░▀░▀▀▀░▀░░▒▀░▀▀▀░▀░░▀░▀▀▀▀░░░▀▀░░

EOF

# copy confis

EOT

sleep 1s
pidof cap | xargs kill -38

chmod +x /mnt/root/cyn.sh
echo "Entering chroot to complete cynageOS setup..."
arch-chroot /mnt /root/cyn.sh

echo "Cleaning cynageOS setup script..."
rm /mnt/root/cyn.sh

mv /var/lib/cos/cos_module_shi/config/ /mnt/home/$USERR/.config/
cp -par /var/lib/cos/cos_module_shi/style/icons/Bibata-Modern-Ice /mnt/usr/share/icons/
cp -par /var/lib/cos/cos_module_shi/style/icons/cynide /mnt/usr/share/icons/
chown -R $USERR:$USERR /mnt/home/$USERR/.config/
chmod 755 /mnt/home/$USERR/.config/

echo "Unmounting and Finishing up"
umount -lR /mnt

pidof cap | xargs kill -39
