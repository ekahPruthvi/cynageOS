#!/bin/bash
# setup files for cynageOS 
# ekahPruthvi <https://github.com/ekahPruthvi>

set -e

USER="$(cat bob.txt)"

cat <<EOT > /mnt/root/cyn.sh
# @@@@@%%%%%%%%%####********+++++++++++++++++++******########%%%%%%%%%%%%%%%%%%%%%%%%%##%######
# @@@@@@@%%%####************++++++++++++++++++++++******########%%%%%%%%%%%%%%%%%%%%%%%#%######
# @@@@%%%%%%%%####*********++++++++++++++++++++++++*******########%%%#%%%%%%%%%%%%%%%%%%#######
# @@@@%%%%%%#####***********+*+++++++++++++++++++++*++******#*########%%%%%%%%%%%%%%%%%%#######
# @@@@%%%%%%######************+**+**++++++++++*+**++++++*****############%%%%%%%%%%%%%%########
# @@%%%%######******************+++++++++++++++++++++++++++******#########%%#%%%%%##%%%########
# @@%%%########*******************++++++++++++++++++++++++++++++*+****########%%%%%##%%########
# @%%%%%####*************************++++++++++++++++=++++++++++++++**#*########%%%%%#%%%#%%%%%
# %%%%%######***************************+++++++++++++==+++++++=++==+=+++**########%%%%%%%%%%%%%
# %%%%%#######**#**#********************+++++++++++++++++=++===+==+++=+++****#######%%%%%%%%%%%
# %%%%#########*##########*******************************+++++++===-=+++=++****#######%%%%%%%%%
# %%%%#############################****************+*++*******+=-=========+++****#######%%%%%%%
# %%%%##########################*****************+++*++++*+++++*#*=:-=--===++++*****#####%%%%%%
# %%%%##################%%########*****************+***++++++*+******=--======++*****######%%%%
# %%%%#############%%%%%#########*****************++++++=+++++++++++**#+=-=====++*******####%%%
# %%%%########%%%%%%%%%%%%%%########*****************+++++++====+++++++***+-==++++*******###%%%
# %%%%%%%%%%%%%%%%%%%%%%%%###########************+++++=++=+===+++==++++++***+==+++*******###%%%
# %%%%%%%%%%%%%%%%%%%%%%%###############**********+++====++++======+==+++++***++++********##%%%
# %%%%%%%%%%%%%%%%%%%%%%%#######################**+*+++==+==++++++====+++++++***+++********##%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%#%%#%%%%%%%%%%%%%%%%%%#####****++++++++++++***+++******###%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@%@@@@@@@@@@@@@@@@@@@@@%%%%%#######**++++*++++**++**######%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@%%@@%%%%%%%%%%%%%%##**++++++*****#####%%%
# %%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@#*%==%%%%####%%%%%%%%%%%##*++++++***#####%%%
# %%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@@@@@@@@@@@@@@@@%%#%%%=+%%%%*==++*##%%%%%%%%%%%#*++++***###%%%%
# %%%%%%%%%%%%%%%%%%%%%@@@@@@@@%%%@@@@@@@@@@@@@@@%%%%%=*%%%%#+---==+*#%%%%%%%%%%%%#*++**###%%%%
# %%%%%%%%%%%%%%%%%@@@@@@@@@%%%%%%@@@@@@@@@@%@@@@@@@%%%%%%%%%*=-----=+**##%%%%@@%%%%######%%%%%
# %%%%%%%%%%%%%%%%%@@@@@@@@%%%#%%%@@@@@@@@%%@@@@@%%%%#%@@%%%%*=--::--==++*#%%%%%%@@@%%%%#%%%%%%
# %%%%%%%%%%%%%@@@@@@@@@@@@%%%###%%@@@@@@@@@@@@@%@@@@@@@%%%%%*=-::::---==+*##%%%%%@%%%%%%%%%%%%
# %%%%%%%%@@@@@@@@@@@@@@@%%%%#####%%@@@@@@@@@@%@@@@@@@@%%%%%#+=-::::---==+**##%%%%%%##%%%%%%%%%
# %%%%%%%%%%%@@@@@@@@@@@@@%%%%%%##%%@@@@@@@@@@@@@@@@%%%%%%%%*=--:::----==++*##%#######%%%%%#%%%
# %%%%%%%%%%%%%%@@@@@@@@@@%%%%%%%%%%%@@@@@@%%%%%@@%%%%%%%%#+=-:::-=++*****+**#***#####%%%%####%
# %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@@@@@%%%%%%%%%%#+=-+++*******+++**#***##**##%%########
# #%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%################******+*++***+++++*###*******##############
# ###%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%########*#**#*************###**********###############
# #######%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%####%###########*##**########***********###############%
# #######################%%%%%%%%%%%%%%%%%%%##%%%%%###########****************##*******########
# ##############*#************###############%%%######**********************************######%
# #***************************************************++++*+++++++**+*+*****************######%
# ***************+*+++++++++++++++++++++++++++++++++++++++++++++++++******++***********#######%
# ***********+++*+++++++++++++++++++++++++++++++++++++++++++++********++++++++********#######%%
# ******++++++++++++++++++++++++++++++++++++++++++++++**+*********+++++++++++++******######%%%%
# *****+++++++++++++++++++++++++++++++++++++++**++*+******++++++++++++++++++++++****######%%%%%
# ***+++++++++++++=+++++===+++++++++++++++++++++++++++++++++++++++++++++++++++++****######%%%%%
# ****++++++++++++++++++==+++++++=++=+++++++++++++++++++=+++++++++++++++++++++++***######%%%%%%
# *++++++++++++++++++=+==++=========++++==+=++++++++======++=+++===++++++++++++****#####%%%%%%%
# ***++++++++++++++++++==+=====================+================+========+=+++*****#####%%%%%%#
# *****++++++++++++++=++=======================================+========++++++*****####%%%%%###
# ******++++++++++++++=================================================+===++++***####%%%%####*
# ******+++++++++++++++===============================================+==+++++****###%%%#####**
# ******++++++++++++++=================================================+=+++++***###%%%########
# *****+++++++++++++======+==============================-===============+++++**###%%%#########
# ***+*+++++++++++++==+===================================-========-=====+++++**##%%%##########
# ***+++++++++++++++===================================-=-=-===----=====+=+++**##%%%###########
# ****++++++++++++++=====+===========================-=-=-==---==--===++++=+**##%%%%###########
# **++++++++*+++======+=++===============================----=-=--=====++++**##%%%%############

cat << EOF

░▀█▀░█▀▀▄░█▀▀░▀█▀░█▀▀▄░█░░█░░░▀░░█▀▀▄░█▀▀▀
░▒█░░█░▒█░▀▀▄░░█░░█▄▄█░█░░█░░░█▀░█░▒█░█░▀▄
░▄█▄░▀░░▀░▀▀▀░░▀░░▀░░▀░▀▀░▀▀░▀▀▀░▀░░▀░▀▀▀▀

░█▀▀▄░█▀▀░█▀▀█░█░▒█░░▀░░█▀▀▄░█▀▀░█▀▄
░█▄▄▀░█▀▀░█▄▄█░█░▒█░░█▀░█▄▄▀░█▀▀░█░█
░▀░▀▀░▀▀▀░░░░█░░▀▀▀░▀▀▀░▀░▀▀░▀▀▀░▀▀░

░▄▀▀▄░█▀▀▄░▄▀▀▄░█▀▀▀░█▀▀▄░█▀▀▄░█▀▄▀█░█▀▀░░░░░
░█▄▄█░█▄▄▀░█░░█░█░▀▄░█▄▄▀░█▄▄█░█░▀░█░▀▀▄░░░▄▄
░█░░░░▀░▀▀░░▀▀░░▀▀▀▀░▀░▀▀░▀░░▀░▀░░▒▀░▀▀▀░░░▀▀

EOF

sleep 2s

cp /etc/sudoers /etc/sudo.bak
echo "%wheel ALL=(ALL) NOPASSWD: /usr/bin/pacman" >> /etc/sudoers

if lspci | grep -E -i 'nvidia|geforce'; then
  pacman -Sy --needed --noconfirm nvidia-open nvidia-utils lib32-nvidia-utils
elif lspci | grep -E -i 'amd|ati|radeon'; then
  pacman -Sy --needed --noconfirm xf86-video-amdgpu linux-firmware-amdgpu linux-firmware-radeon vulkan-radeon
fi 

for pkg in /root/req_pkgs/*.pkg.tar.zst; do
  su - $USER -c 'yay -U --noconfirm "$pkg"'
done
su - $USER -c 'yay -S --noconfirm min-browser-bin'

mv /etc/sudo.bak /etc/sudoers

cat << EOF

░▒█▀▀█░█▀▀░▀█▀░▀█▀░░▀░░█▀▀▄░█▀▀▀
░▒█░▄▄░█▀▀░░█░░░█░░░█▀░█░▒█░█░▀▄
░▒█▄▄▀░▀▀▀░░▀░░░▀░░▀▀▀░▀░░▀░▀▀▀▀

░█▀▄░█░░█░█▀▀▄░█▀▀▄░█▀▀▀░█▀▀░▒█▀▀▀█░▒█▀▀▀█
░█░░░█▄▄█░█░▒█░█▄▄█░█░▀▄░█▀▀░▒█░░▒█░░▀▀▀▄▄
░▀▀▀░▄▄▄▀░▀░░▀░▀░░▀░▀▀▀▀░▀▀▀░▒█▄▄▄█░▒█▄▄▄█

░█▀▀░█▀▄░▄▀▀▄░█▀▀░█░░█░█▀▀░▀█▀░█▀▀░█▀▄▀█
░█▀▀░█░░░█░░█░▀▀▄░█▄▄█░▀▀▄░░█░░█▀▀░█░▀░█
░▀▀▀░▀▀▀░░▀▀░░▀▀▀░▄▄▄▀░▀▀▀░░▀░░▀▀▀░▀░░▒▀

░▒█▀▀▄░█▀▀░█▀▀▄░█▀▄░█░░█░░░░░
░▒█▄▄▀░█▀▀░█▄▄█░█░█░█▄▄█░▄▄░░
░▒█░▒█░▀▀▀░▀░░▀░▀▀░░▄▄▄▀░▀▀░░

EOF

sed -i -E -e "s|^command = .*|command = \"cage -m last -s /usr/bin/octobacillus\"|" "/etc/greetd/config.toml"
systemctl enable greetd.service

cat << EOF

░▒█▀▀▀░░▀░░█▀▀▄░░▀░░█▀▀░█░░░░░▀░░█▀▀▄░█▀▀▀
░▒█▀▀░░░█▀░█░▒█░░█▀░▀▀▄░█▀▀█░░█▀░█░▒█░█░▀▄
░▒█░░░░▀▀▀░▀░░▀░▀▀▀░▀▀▀░▀░░▀░▀▀▀░▀░░▀░▀▀▀▀

░░░▀▀█▀▀░█░░░░█▀▀░█▀▄▀█░░▀░░█▀▀▄░█▀▀▀░░░░░░░
░░░░▒█░░░█▀▀█░█▀▀░█░▀░█░░█▀░█░▒█░█░▀▄░░░▄▄░░
░░░░▒█░░░▀░░▀░▀▀▀░▀░░▒▀░▀▀▀░▀░░▀░▀▀▀▀░░░▀▀░░

EOF

# copy confis

EOT

# sleep 1s
# pidof cap | xargs kill -38 FOR CPYING CONFIGS

chmod +x /mnt/root/cyn.sh
echo "Entering chroot to complete cynageOS setup..."
arch-chroot /mnt /root/cyn.sh

echo "Cleaning cynageOS setup script..."
rm /mnt/root/cyn.sh

mv /var/lib/cos/cos_module_shi/config/ /mnt/home/$USER/.config/
mv /var/lib/cos/cos_module_shi/style/icons/ /mnt/usr/share/icons/
mv /var/lib/cos/cos_module_shi/style/icons/ /mnt/home/$USER/.icons/
mv /var/lib/cos/cos_module_shi/style/themes/ /mnt/usr/share/themes/
mv /var/lib/cos/cos_module_shi/style/themes/ /mnt/home/$USER/.themes/

echo "Unmounting and Finishing up"
umount -lR /mnt

pidof cap | xargs kill -39